version: "3"

volumes:
  cachefs:
  pgdata:
  esdata:

services:
  # DATABASES
  mongo:
    image: mongo:3.4.4
    ports:
      - 27017
    volumes:
      - ../:/rover

  elastic:
    container_name: elastic5
    image: docker.elastic.co/elasticsearch/elasticsearch:5.5.2
    ports:
      - 9200
      - 9300
    volumes:
      - ../:/rover
      - esdata:/usr/share/elasticsearch/data
    environment:
      xpack.monitoring.enabled: "false"
      xpack.security.enabled: "false"
      transport.host: "127.0.0.1"
      network.host: "0.0.0.0"
      http.host: "0.0.0.0"
      cluster.name: docker-cluster
      bootstrap.memory_lock: "true"
      ES_JAVA_OPTS: "-Xms512m -Xmx512m"

  postgres:
    image: postgres:9.6-alpine
    ports: [5432]
    volumes:
      # postgres runs *.sql from /docker-entrypoint-initdb.d on startup
      - ./vendor/postgres/initdb.d:/docker-entrypoint-initdb.d/

  redis:
    image: redis:4.0.2-alpine

  rabbitmq:
    build:
      context: ./vendor/rabbitmq
    ports:
      - 15672:15672

  # ROVER PROJECTS
  audience-frontend:
    image: node:6.12.0
    depends_on:
      - graphql-gateway
    volumes:
      - ../:/rover/
    working_dir: /rover/react-audience
    command: bash -c "/rover/docker/scripts/wait.sh graphql-gateway:80 -t 60 -- npm install && npm run schema && npm run relay && npm start"
    environment:
      NODE_ENV: development
      GRAPHQL_HOST: "http://graphql-gateway/graphql"
  audience-service:
    image: golang:1.9-alpine
    depends_on:
      - mongo
      - elastic
    command: ./docker/audience-service/cmd run
    volumes:
      - ../:/go/src/github.com/roverplatform/rover
    working_dir: /go/src/github.com/roverplatform/rover
    environment:
      CGO_ENABLED: 0
      AUDIENCE_SERVICE_MONGO_DSN: "mongodb://mongo:27017/audience_service_dev"
      AUDIENCE_SERVICE_ELASTIC_DSN: "http://elastic5:9200"
  
  auth-service:
    image: golang:1.9-alpine
    working_dir: /go/src/github.com/roverplatform/rover
    depends_on:
      - postgres
    command: ./docker/auth-service/cmd migrate run
    volumes:
      - ../:/go/src/github.com/roverplatform/rover
    environment:
      CGO_ENABLED: 0
      DB_DSN: "postgres://postgres:@postgres:5432/authsvc_dev?sslmode=disable"
      MIGRATION_DIR: ./auth/service/db/migrations/postgres

  campaigns-service:
    image: golang:1.9-alpine
    working_dir: /go/src/github.com/roverplatform/rover
    depends_on:
      - postgres
    command: ./docker/campaigns-service/cmd migrate run
    volumes:
      - ../:/go/src/github.com/roverplatform/rover
    environment:
      CGO_ENABLED: 0
      DB_DSN: "postgres://postgres:@postgres:5432/campaigns_dev?sslmode=disable"
      TEST_DSN: "postgres://postgres:@postgres:5432/campaigns_test?sslmode=disable"

  campaigns-frontend:
    image: node:7.5.0
    depends_on:
      - graphql-gateway
    volumes:
      - ../:/rover/
    working_dir: /rover/react-campaigns
    command: bash -c "npm install && npm start"
    environment:
      NODE_ENV: development
      GRAPHQL_HOST: "http://graphql-gateway/graphql"
 
  graphql-gateway:
    image: node:7.5.0
    depends_on:
      - auth-service
      - audience-service
      - campaigns-service
    ports:
      - "4000:80"
    command: bash -c "npm install && npm run build && npm start"
    volumes:
      - ../:/rover/
    working_dir: /rover/graphql-gateway
    environment:
      AUTH_V1_SERVICE_HOST: auth-service
      AUDIENCE_V1_SERVICE_HOST: audience-service
      CAMPAIGNS_V1_SERVICE_HOST: campaigns-service
      NODE_ENV: development

  geocoder-service:
    image: golang:1.9-alpine
    working_dir: /go/src/github.com/roverplatform/rover
    depends_on:
      - redis
    command: go run ./geocoder/service/cmd/service/main.go
    volumes:
      - ../:/go/src/github.com/roverplatform/rover
    environment:
      GEOCODER_SERVICE_GCP_API_KEY: "AIzaSyBNFTti0wKJ3J_FMw1tCpTB4bPyQ8j53bc"
      GEOCODER_SERVICE_REDIS_DSN: "redis://redis:6379/3"

  smw:
    image: node:6.9.1
    working_dir: /rover/scheduled-messages-worker
    volumes:
      - ../:/rover/
    depends_on:
      - mongo
      - rabbitmq
      - redis
      - audience-service
    command: bash -c "/rover/docker/scripts/wait.sh rabbitmq:5672 -s -- npm install && node index.js"
    environment:
      NODE_ENV: production
      LOG_LEVEL: DEBUG
      DEBUG: job:*
      DEBUG_COLORS: 1
      REDIS_URL: redis://redis/1
      REDIS_INBOX_URL: redis://redis/2
      RAVEN_ENABLED: "false"
      CLOUDAMQP_URL: amqp://rabbitmq
      MONGODB_URI: mongodb://mongo:27017/rover-local
      AUDIENCE_V1_SERVICE_HOST: audience-service
      NPM_TOKEN: dad33a01-0f48-47df-9797-9b36dd5f957c

  sdk-api:
    image: node:7.5
    depends_on:
      - rabbitmq
      - redis
      - postgres
      - audience-service
      - auth-service
      - geocoder-service
    working_dir: /rover/sdk-api
    ports: ["3100:3100"]
    volumes:
      - ../:/rover
    command: bash -c "/rover/docker/scripts/wait.sh rabbitmq:5672 -- npm install && npm run dev"
    environment:
      NODE_ENV: production

      POSTGRESQL_DB_HOST: postgres
      POSTGRESQL_DB_NAME: rover-local

      REDIS_URL: redis://redis:6379/0
      REDIS_INBOX_URL: redis://redis:6379/1

      AUDIENCE_V1_SERVICE_HOST: audience-service
      AUTH_V1_SERVICE_HOST: auth-service
      GEOCODER_V1_SERVICE_HOST: geocoder-service

      MONGODB_URI: mongodb://mongo:27017/sdk-api-dev

      ELASTICSEARCH_URLS: http://elastic:9200/

      CLOUDAMQP_URL: amqp://rabbitmq

      LOG_LEVEL: "debug"
      PORT: 3100
